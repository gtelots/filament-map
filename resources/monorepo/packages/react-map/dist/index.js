import { createPathComponent, createElementObject, extendContext, createControlComponent } from '@react-leaflet/core';
import H, { GeoJSON, Control } from 'leaflet';
import { isArray, get, isFunction, last, map, template, isString } from 'lodash';
import { jsx, jsxs } from 'react/jsx-runtime';
import { createContext, useRef, useContext, useState, useEffect, useMemo, Fragment } from 'react';
import { point, lineString, polygon, feature, multiPoint, multiLineString, multiPolygon, geometryCollection } from '@turf/helpers';
import { getType, getCoords, getCoord, getGeom } from '@turf/invariant';
import { flattenEach, featureEach } from '@turf/meta';
import { useMap, LayersControl, TileLayer, WMSTileLayer, ZoomControl, AttributionControl, ScaleControl } from 'react-leaflet';
import { createEntityAdapter, nanoid } from '@reduxjs/toolkit';
import { createStore, useStore } from 'zustand';
import { immer } from 'zustand/middleware/immer';
import { useUpdateEffect } from 'react-use';
import { circle } from '@turf/circle';
import { pointOnFeature } from '@turf/point-on-feature';
import { isPoint, isGeoJSONObject } from 'geojson-validation';
import Ze from 'leaflet/dist/images/marker-icon.png';
import ve from 'leaflet/dist/images/marker-icon-2x.png';
import Me from 'leaflet/dist/images/marker-shadow.png';
import We from '@turf/center';
import Ne from '@turf/flip';
import { bbox } from '@turf/bbox';
import { GeomanControls } from 'react-leaflet-geoman-v2';
import 'leaflet.fullscreen';
import 'leaflet.fullscreen/Control.FullScreen.css';
import { renderToString } from 'react-dom/server';

var b=createPathComponent(function({data:r,...t},e){let a=new GeoJSON(r,t);return createElementObject(a,extendContext(e,{overlayContainer:a}))},function(r,t,e){t.data!==e.data&&r.clearLayers().addData(t.data),t.style!==e.style&&(t.style==null?r.resetStyle():r.setStyle(t.style));});var B=(o,r)=>o?template(o,{interpolate:/{{([\s\S]+?)}}/g})(r):"";function ae(o){let{template:r,heading:t,content:e,data:a}=o;return r?jsx("div",{dangerouslySetInnerHTML:{__html:B(r,a)}}):jsxs("div",{children:[jsx("div",{className:"pc-heading",children:B(t,a)}),jsx("hr",{}),isArray(e)?jsx("div",{children:e?.map((s,i)=>jsxs("div",{children:[jsxs("span",{className:"pc-content-label",children:[s.label,": "]}),get(a,s.value)]},i))}):jsx("div",{dangerouslySetInnerHTML:{__html:B(e,a)}})]})}var V=ae;function se(o){let{dataUrl:r,children:t,...e}=o,[a,s]=useState(!1),[i,f]=useState(null);return useEffect(()=>{a&&r&&fetch(r).then(d=>d.json()).then(d=>{f(d);});},[a,r]),jsx(b,{...e,data:i,eventHandlers:{add:d=>{s(!0);},remove:d=>{s(!1);}},children:isFunction(t)&&i&&t(i)})}var W=se;var G=createEntityAdapter(),N=G.getSelectors(o=>o),Q=G.getInitialState({$wire:null,$watch:null,state:null,config:{}}),Ge=(o,r)=>({addFeature:t=>o(e=>{G.addOne(e,{id:nanoid(),...t});}),updateFeature:t=>o(e=>{G.updateOne(e,t);}),removeFeature:t=>o(e=>{G.removeOne(e,t);}),setFeatures:t=>o(e=>{G.setAll(e,t);}),removeFeatures:()=>o(t=>{G.removeAll(t);})}),T=createContext(null),Ce=({children:o,value:r})=>{let t=useRef();return t.current||(t.current=createStore()(immer((e,a)=>({...Q,...r,...Ge(e),reset:()=>({...Q,...r})})))),jsx(T.Provider,{value:t.current,children:o})},O=o=>{let r=useContext(T);if(!r)throw new Error("Missing MapStoreProvider");return useStore(r,o)};function Xe({state:o,setFeatures:r}){let t=getType(o);if(t==="MultiPoint")r(getCoords(o).map(e=>({id:nanoid(),...point(e)})));else if(t==="MultiLineString")r(getCoords(o).map(e=>({id:nanoid(),...lineString(e)})));else if(t==="MultiPolygon")r(getCoords(o).map(e=>({id:nanoid(),...polygon(e)})));else if(["Point","LineString","Polygon"].includes(t))r([{id:nanoid(),...feature(o)}]);else if(t==="GeometryCollection"){let e=[];flattenEach(o,a=>e.push({id:nanoid(),...a})),r(e);}}var X=Xe;function Be(o={}){H.Icon.Default.mergeOptions({iconUrl:Ze,iconRetinaUrl:ve,shadowUrl:Me,...o});}var Re=Be;function we(o){return o&&getCoord(Ne(We(o)))}var I=we;function Ue(o){let r=bbox(o);return [[r[1],r[0]],[r[3],r[2]]]}var Z=Ue;function Te({state:o,config:{zoomToFeature:r},map:t}){let e=getGeom(o);if(isPoint(e)){if(r){let a=Z(circle(o,.25,{steps:4}));t.fitBounds(a,{animate:!1});}else t.panTo(I(o),{animate:!1});return}if(isGeoJSONObject(e))if(r){let a=Z(o);t.fitBounds(a,{animate:!1});}else t.panTo(I(pointOnFeature(o)));}var P=Te;function rt(){let o=useMap(),[r,t,e,a,s,i,f,d,k,l,g,c,m,F,x]=O(n=>[n.state,n.$wire,n.config.geomType,n.config.latitudeField,n.config.longitudeField,n.config.drawField,n.config.zoomToFeature,n.config.markerOptions,n.config.polylineOptions,n.config.polygonOptions,n.config.rectangleOptions,N.selectAll(n),n.updateFeature,n.setFeatures,n.removeFeature]);return useEffect(()=>{r&&(X({state:r,setFeatures:F}),P({state:r,config:{zoomToFeature:f},map:o}));},[]),useUpdateEffect(()=>{if(c?.length){if(["Point","LineString","Polygon"].includes(e)&&c?.length===1){let n=getGeom(last(c));if(e==="Point"){let p=getCoord(n);a&&t.set(a,p[1],!1),s&&t.set(s,p[0],!1);}i&&t.set(i,JSON.stringify(n),!1);}else if(e==="MultiPoint"){let n=getGeom(multiPoint(map(c,p=>getCoord(p))));i&&t.set(i,JSON.stringify(n),!1);}else if(e==="MultiLineString"){let n=getGeom(multiLineString(map(c,p=>getCoords(p))));i&&t.set(i,JSON.stringify(n),!1);}else if(e==="MultiPolygon"){let n=getGeom(multiPolygon(map(c,p=>getCoords(p))));i&&t.set(i,JSON.stringify(n),!1);}else if(e==="GeometryCollection"){let n=getGeom(geometryCollection(map(c,p=>getGeom(p))));i&&t.set(i,JSON.stringify(n),!1);}}else i&&t.set(i,"",!1);},[JSON.stringify(c)]),c?.map((n,p)=>jsx(b,{data:n,pointToLayer:(u,S)=>{let y={...d};return y.icon&&(y.icon=H.icon(y.icon)),H.marker(S,y)},style:()=>({...k,...l,...g}),eventHandlers:{"pm:update":({layer:u,target:S})=>{featureEach(S.toGeoJSON(),(y,A)=>{m({id:y.id,changes:y});});},"pm:cut":u=>{o.removeLayer(u.layer);let S=get(u,"originalLayer.feature.id");x(S);let y=getType(u.layer.toGeoJSON()),A=getGeom(y===e?u.layer.toGeoJSON():u.originalLayer.toGeoJSON());X({state:A,setFeatures:F});}}},p))}var nt=rt;var U=createControlComponent(function(r){return new Control.FullScreen(r)});function ct(o){let{type:r,popupTemplate:t,...e}=o,a=t?isString(t)?{template:t}:t:{};if(r==="wms"){let s={url:"",format:"image/png",transparent:!0,...e};return jsx(WMSTileLayer,{...s})}if(r==="geojson"){let s={pointToLayer:(i,f)=>{let d={...e.markerOptions};return d.icon&&(d.icon=H.icon(d.icon)),H.marker(f,d)},style:i=>({...e.polylineOptions,...e.polygonOptions,...e.rectangleOptions}),onEachFeature:(i,f)=>{t&&f.bindPopup(()=>renderToString(jsx(V,{data:i?.properties,...a})));}};if(e.data)return s={...s,data:isString(e.data)?JSON.parse(e.data):e.data},jsx(b,{...s});if(e.dataUrl)return s={...s,dataUrl:e.dataUrl},jsx(W,{...s})}return null}var $=ct;var Ct={zoomControl:ZoomControl,layersControl:LayersControl,drawControl:GeomanControls,attributionControl:AttributionControl,scaleControl:ScaleControl,fullscreenControl:U},Ot={drawMarker:!1,drawCircle:!1,drawCircleMarker:!1,drawPolyline:!1,drawRectangle:!1,drawPolygon:!1,drawText:!1,editMode:!0,dragMode:!1,cutPolygon:!1,removalMode:!0,rotateMode:!1};function Ft(){let[o,r,t,e]=O(l=>[l.config.geomType,l.config.layers,l.config.baseLayers,l.config.controls]),[a,s,i]=O(l=>[l.addFeature,l.removeFeature,l.removeFeatures]),f=l=>{l.target.removeLayer(l.layer),["Point","LineString","Polygon"].includes(o)&&i(),a(l.layer.toGeoJSON());},d=({layer:l,target:g})=>{let c=l.feature.id;c&&s(c);};return useMemo(()=>map(e,(l,g)=>{let c=Ct[g];if(!l||l?.enabled==!1||!c)return null;let m={...l},F=null;return g==="layersControl"&&(F=jsxs(Fragment,{children:[t?.map(({selected:x=!1,title:n="None",...p},u)=>jsx(LayersControl.BaseLayer,{name:n,checked:x,children:jsx(TileLayer,{url:"",...p})},u)),r?.map(({selected:x=!1,title:n="None",...p},u)=>jsx(LayersControl.Overlay,{name:n,checked:x,children:jsx($,{...p})},u))]})),g==="drawControl"&&(m={...m,options:Ot},["Point","MultiPoint"].includes(o)?m.options={...m.options,drawMarker:!0,editMode:!0,removalMode:!0}:["LineString","MultiLineString"].includes(o)?m.options={...m.options,drawPolyline:!0,editMode:!0,dragMode:!0,cutPolygon:!0,removalMode:!0,rotateMode:!0}:["Polygon","MultiPolygon"].includes(o)?m.options={...m.options,drawRectangle:!0,drawPolygon:!0,editMode:!0,dragMode:!0,cutPolygon:!0,removalMode:!0,rotateMode:!0}:m.options={...m.options,drawMarker:!0,drawCircle:!0,drawPolyline:!0,drawRectangle:!0,drawPolygon:!0,editMode:!0,dragMode:!0,cutPolygon:!0,removalMode:!0,rotateMode:!0},m.onCreate=f,m.onMapRemove=d),jsx(c,{...m,children:F},g)}).filter(l=>l),[JSON.stringify(e)]).map(l=>l)}var xt=Ft;

export { xt as ControlManager, nt as FeatureManager, U as FullscreenControl, b as GeoJSON, W as GeoJSONAjax, Ce as MapStoreProvider, V as PopupTemplate, N as featuresSelectors, Re as setDefaultIcon, X as setFeaturesByState, Z as toBounds, I as toLatLng, O as useMapStore, P as zoomToFeatureByState };
//# sourceMappingURL=out.js.map
//# sourceMappingURL=index.js.map